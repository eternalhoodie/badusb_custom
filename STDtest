$hook = "https://discord.com/api/webhooks/1366201501802041374/ENdipWjx_vaIQYHXDYo-kwppUazTUQ9LpTj7oewX0g_wln4_vi9F_HdVdiaiBjFoovZY"
$reportPath = "$env:TEMP\DefenderScan-$(Get-Date -f yyyyMMddHHmm).txt"

try {
    # Initialize report
    "=== Windows Defender Scan Report ===" | Out-File $reportPath
    "Scan started: $(Get-Date -Format u)" | Out-File $reportPath -Append

    # Update signatures
    Update-MpSignature -ErrorAction Stop
    "Signature update completed" | Out-File $reportPath -Append

    # Start scan with progress monitoring
    $scan = Start-MpScan -ScanType FullScan -AsJob -ErrorAction Stop
    
    # Monitor scan status
    while ($scan.State -eq 'Running') {
        $status = Get-MpComputerStatus
        "Scan progress: $($status.FullScanProgress)%" | Out-File $reportPath -Append
        Start-Sleep -Seconds 30
    }

    # Get results using WMI for better reliability
    $threats = Get-CimInstance -Namespace root/Microsoft/Windows/Defender -ClassName MSFT_MpThreat
    
    if ($threats) {
        "`n=== Detected Threats ===" | Out-File $reportPath -Append
        $threats | Select-Object ThreatName,Path,Severity | Format-Table -AutoSize | Out-File $reportPath -Append
    }
    else {
        "`nNo threats detected" | Out-File $reportPath -Append
    }

    # Add protection status
    "`n=== Protection Status ===" | Out-File $reportPath -Append
    Get-MpComputerStatus | Select-Object AntivirusEnabled,AntivirusSignatureAge,RealTimeProtectionEnabled | Format-List | Out-File $reportPath -Append

    # Send report via native PowerShell (corrected)
$fileContent = [System.IO.File]::ReadAllBytes($reportPath)
$boundary = [System.Guid]::NewGuid().ToString()
$LF = "`r`n"

$body = @(
    "--$boundary",
    "Content-Disposition: form-data; name=`"file`"; filename=`"$(Split-Path $reportPath -Leaf)`"",
    "Content-Type: text/plain$LF",
    [System.Text.Encoding]::UTF8.GetString($fileContent),
    "--$boundary--"
) -join $LF

Invoke-RestMethod -Uri $hook -Method Post `
    -ContentType "multipart/form-data; boundary=$boundary" `
    -Body $body

